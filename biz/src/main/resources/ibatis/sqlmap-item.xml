<?xml version="1.0" encoding="GB2312"?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="item">
	
	<typeAlias alias="item" type="com.hsh24.mall.api.item.bo.Item" />
	
	<select id="getItemList" parameterClass="item" resultClass="item">
	<![CDATA[
		SELECT t.item_id AS itemId,
		  t.item_no      AS itemNo,
		  t.item_name    AS itemName,
		  t.price,
		  t.stock,
		  t.postage,
		  t.quota,
		  t.origin,
		  t.remark
		FROM dms.dms_tb_item t
		WHERE t.state = 'U'
		AND t.shop_id = #shopId#
	]]>
		<dynamic>
			<isNotEmpty property="codes" prepend="and">
			<![CDATA[ t.item_id IN ]]>
				<iterate property="codes" open="(" close=")" conjunction=",">#codes[]#</iterate>
			</isNotEmpty>
		</dynamic>
	<![CDATA[
		ORDER BY t.item_name, t.item_id
		LIMIT $limit$ OFFSET $offset$
	]]>
	</select>
	
	<select id="getItem" parameterClass="item" resultClass="item">
	<![CDATA[
		SELECT t.item_id AS itemId,
		  t.item_no      AS itemNo,
		  t.item_name    AS itemName,
		  t.price,
		  t.stock,
		  t.postage,
		  t.quota,
		  t.origin,
		  t.remark
		FROM dms.dms_tb_item t
		WHERE t.state = 'U'
		AND t.shop_id = #shopId#
		AND t.item_id = #itemId#
	]]>		
	</select>
	
	<update id="updateItem1" parameterClass="item">
	<![CDATA[
		UPDATE dms.dms_tb_item t
		SET t.modify_date = NOW(),
		  t.modify_user   = #modifyUser#,
		  t.stock         =
		  (SELECT IFNULL(SUM(p.stock), 0)
		  FROM dms.dms_tb_item_sku p
		  WHERE p.state = 'U'
		  AND p.item_id = t.item_id
		  )
		WHERE t.state  = 'U'
		AND t.shop_id  = #shopId#
		AND t.item_id IN
	]]>
		<iterate property="codes" open="(" close=")" conjunction=",">#codes[]#</iterate>
	</update>
	
	<update id="updateItem2" parameterClass="item">
	<![CDATA[
		UPDATE dms.dms_tb_item t
		SET t.modify_date = NOW(),
		  t.modify_user   = #modifyUser#,
		  t.stock         = #stock#
		WHERE t.state     = 'U'
		AND t.shop_id     = #shopId#
		AND t.item_id     = #itemId#
	]]>
	</update>
	
</sqlMap>